#!/bin/sh

CONTAINER_NAME="zusam"

cdroot() {
    if ! [ -d ".git" ] && [ "$(pwd)" != "/" ]; then
        cd ..
        cdroot
    fi
}

start_docker_service() {
    if [ -n "$(which systemctl 2>/dev/null)" ]; then
        sudo systemctl start docker
        return
    fi
    if [ -n "$(which service 2>/dev/null)" ]; then
        sudo service docker start
        return
    fi
}

isDockerRunning() {
    if [ -n "$(sudo docker info 2>&1 1>/dev/null)" ] && [ -z "$(sudo docker info)" ]; then
        echo "the docker daemon is not running"
        exit 1
    fi
}

start_docker_service
isDockerRunning

cdroot
pathToProject=$(pwd)
[ -z "$INSTANCE_TYPE" ] && INSTANCE_TYPE="default"

if [ -n "$(sudo docker ps -a | grep "$CONTAINER_NAME")" ]; then
    sudo docker stop "$CONTAINER_NAME" && sudo docker rm "$CONTAINER_NAME"
fi

if sudo docker build -t "$CONTAINER_NAME" .; then
    sudo docker run -d --rm \
        --tmpfs /tmp \
        -e UID="$(id -u)" -e GID="$(id -g)" \
        -e INSTANCE_TYPE=${INSTANCE_TYPE} \
        -p 80:8080 \
        -v "${pathToProject}"/data:/zusam/data \
        -v "${pathToProject}"/public:/zusam/public \
        -v "${pathToProject}"/api:/zusam/api \
        --name "$CONTAINER_NAME" "$CONTAINER_NAME"
fi

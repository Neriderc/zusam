!function(e,n){function a(t){var e;e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var n=t.split(",")[0].split(":")[1].split(";")[0],a=new Uint8Array(e.length),i=0;i<e.length;i++)a[i]=e.charCodeAt(i);return new Blob([a],{type:n})}function i(t,e){img=new Image,img.onload=function(){canvas=document.createElement("canvas");var t=Math.min(img.width,1024),n=Math.min(img.height,1024),a=Math.min(t/img.width,n/img.height);canvas.width=img.width*a,canvas.height=img.height*a,ctx=canvas.getContext("2d"),ctx.drawImage(img,0,0,img.width*a,img.height*a),canvas.dataset.w=img.width*a,canvas.dataset.h=img.height*a,URL.revokeObjectURL(img.src),img=null,$(e).append(canvas),d(e),zone=$('<div data-movable="true" class="zone"></div>'),cachetop=$('<div class="cachetop cache"></div>'),cachebottom=$('<div class="cachebottom cache"></div>'),cacheleft=$('<div class="cacheleft cache"></div>'),cacheright=$('<div class="cacheright cache"></div>'),handletl=$('<div class="unselectable handlecontainer handletl"><div class="handle"></div></div>'),handletr=$('<div class="unselectable handlecontainer handletr"><div class="handle"></div></div>'),handlebl=$('<div class="unselectable handlecontainer handlebl"><div class="handle"></div></div>'),handlebr=$('<div class="unselectable handlecontainer handlebr"><div class="handle"></div></div>'),$(e).append(zone),$(e).append(cachetop),$(e).append(cachebottom),$(e).append(cacheleft),$(e).append(cacheright),$(e).append(handletl),$(e).append(handletr),$(e).append(handlebl),$(e).append(handlebr),z=$(e+" > .zone")[0],u(z,"movable",null,e),x=document.querySelector(e).offsetHeight,y=document.querySelector(e).offsetWidth,w=parseInt($(e).attr("data-w")),h=parseInt($(e).attr("data-h")),(null==w||null==h)&&(w=h=128),o(z,(x-h)/2,(y-w)/2,w,h),z=$(e+" > .handletl")[0],u(z,"resizeHandletl",e+" > .zone",e),z=$(e+" > .handletr")[0],u(z,"resizeHandletr",e+" > .zone",e),z=$(e+" > .handlebl")[0],u(z,"resizeHandlebl",e+" > .zone",e),z=$(e+" > .handlebr")[0],u(z,"resizeHandlebr",e+" > .zone",e),menu=$('<div class="menu"><div class="menu-cell"><button class="cancelit" onclick="togglenewavatar()">Cancel</button></div><div class="menu-cell"><button class="sendit">Submit</button></div></div>'),menu.on("click",function(){L(e)}),$(e).parent().append(menu)},img.src=URL.createObjectURL(t)}function c(t){id=t.data;var e=t.target.files[0];e.type.match("image.*")&&($(id+" > i").removeClass("fa-photo").addClass("fa-cog fa-spin").css({top:"calc(50% - 25px)",left:"calc(50% - 25px)"}),i(e,id))}function o(t,e,n,a,i){p=t.parentNode,a=Math.max(a,64),i=Math.max(i,64),a=Math.min(a,p.offsetWidth),i=Math.min(i,p.offsetHeight),e=Math.max(e,0),n=Math.max(n,0),e=Math.min(e,p.offsetHeight-i),n=Math.min(n,p.offsetWidth-a),e=parseInt(e),n=parseInt(n),a=parseInt(a),i=parseInt(i),t.style.width=a,t.style.height=i,t.style.top=e,t.style.left=n,ct=t.nextSibling,ct.style.height=e,cb=ct.nextSibling,cb.style.top=e+i,cl=cb.nextSibling,cl.style.height=i,cl.style.width=n,cl.style.top=e,cr=cl.nextSibling,cr.style.height=i,cr.style.top=e,cr.style.left=n+a,htl=cr.nextSibling,htl.style.top=e-12,htl.style.left=n-12,htr=htl.nextSibling,htr.style.top=e-12,htr.style.left=n-12+a,hbl=htr.nextSibling,hbl.style.top=e-12+i,hbl.style.left=n-12,hbr=hbl.nextSibling,hbr.style.top=e-12+i,hbr.style.left=n-12+a}function s(t,e,n,a,i){window.s=new Object,window.s.elmt=t.target,window.s.type=n,window.blockScroll=!0,"mousedown"==t.type?(cx=t.clientX,cy=t.clientY):(cx=t.touches[0].clientX,cy=t.touches[0].clientY),rect=t.target.getBoundingClientRect(),offsetX=parseInt(cx-rect.left),offsetY=parseInt(cy-rect.top),window.s.offsetX=offsetX,window.s.offsetY=offsetY,window.s.clientX=parseInt(cx),window.s.clientY=parseInt(cy),window.s.action=document.querySelector(a),z=document.querySelector(i+" > .zone"),window.s.t=parseInt(z.style.top),window.s.l=parseInt(z.style.left),window.s.w=z.offsetWidth,window.s.h=z.offsetHeight}function d(t){$(t+" .label").remove(),$(t+" .underLabel").remove(),$(t+" input").remove(),$(t).css("height","auto")}function m(e){null!=window.s&&null!=window.s.type&&("mousemove"==e.type?(cx=e.clientX,cy=e.clientY):(cx=e.touches[0].clientX,cy=e.touches[0].clientY),"movable"==window.s.type&&(r=window.s.elmt.parentNode.getBoundingClientRect(),t=cy-r.top-window.s.offsetY,l=cx-r.left-window.s.offsetX,w=window.s.w,h=window.s.h,(l!=window.s.l||t!=window.s.t)&&o(window.s.elmt,t,l,w,h)),"r"==window.s.type[0]&&(target=window.s.action,t=window.s.t,l=window.s.l,w=window.s.w,h=window.s.h,mx=cx-window.s.clientX,my=cy-window.s.clientY,g=0,"resizeHandletl"==window.s.type&&(g=(-mx-my)/2,t-=g,l-=g),"resizeHandletr"==window.s.type&&(g=(mx-my)/2,t-=g),"resizeHandlebl"==window.s.type&&(g=(-mx+my)/2,l-=g),"resizeHandlebr"==window.s.type&&(g=(mx+my)/2),w+=g,h+=g,(t!=window.s.t||l!=window.s.l||w!=window.s.w||h!=window.s.h)&&o(target,t,l,w,h)))}function u(t,e,n,a){t.addEventListener("mousedown",function(i){s(i,t,e,n,a)},!1),t.addEventListener("touchstart",function(i){s(i,t,e,n,a)},!1)}function v(t){document.body.addEventListener("mousemove",function(t){m(t)},!1),document.body.addEventListener("touchmove",function(t){m(t)},!1),document.body.addEventListener("mouseup",function(){window.s=null},!1),document.body.addEventListener("touchend",function(){window.s=null,window.blockScroll=!1},!1),$(window).on("touchmove",function(t){window.blockScroll&&t.preventDefault()}),b(t)}function b(t){$(t+" > input").off(),$(t+" > input").on("change",null,t,c)}function I(t){$(t+" > input").off()}function L(e){canvas=document.querySelector(e+" canvas");var n=canvas.getContext("2d");g=canvas.offsetWidth/parseInt(canvas.dataset.w),z=document.querySelector(e+" > .zone"),l=parseInt(z.style.left)/g,t=parseInt(z.style.top)/g,w=parseInt(z.style.width)/g,h=parseInt(z.style.height)/g,data=n.getImageData(l,t,w,h),g=Math.min(Math.min(w,256)/w,Math.min(h,256)/h),c2=document.createElement("canvas"),c2.width=parseInt(w),c2.height=parseInt(h),ctx2=c2.getContext("2d"),ctx2.putImageData(data,0,0),imgURL=c2.toDataURL("image/png"),htmlImage=$("<img>").attr("src",imgURL)[0],delete c2,delete ctx2,delete imgURL,c3=document.createElement("canvas"),c3.width=parseInt(w*g),c3.height=parseInt(h*g),ctx3=c3.getContext("2d"),ctx3.transform(g,0,0,g,0,0),ctx3.drawImage(htmlImage,0,0),imgURL=c3.toDataURL("image/png"),delete c3,delete ctx3,delete htmlImage,f=new FormData,f.append("avatar",a(imgURL));var i=$("#info").attr("data-uid"),c=$("#info").attr("data-forum"),o=$(e).attr("data-action");f.append("uid",i),f.append("fid",c),f.append("action",o),$.ajax({url:"Ajax/post.php",type:"POST",data:f,success:function(t){console.log(t),location.reload()},error:function(){console.log("fail")},processData:!1,contentType:!1}),togglenewavatar(e)}n.retouche=e,URL=window.URL||window.webkitURL,e.dataURItoBlob=a,e.loadImage=i,e.handleFileSelect=c,e.setZone=o,e.downEvent=s,e.stopInput=d,e.moveEvent=m,e.setAsType=u,e.start=v,e.restart=b,e.stop=I,e.sendCanvas=L}({},function(){return this}());
